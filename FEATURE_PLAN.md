# 功能开发清单（结合 UI、用户旅程与数据准则）

> **数据准则**：所有业务数据（快捷操作、模板、列表、内容、配置等）必须持久化在 MySQL 数据库中，严禁再依赖 JSON / 本地文件或硬编码数据源。若文中提及数据仍在迁移计划中，务必在实现阶段建立表结构、迁移脚本与种子数据。

状态标记：✅ 已完成 ｜ 🔄 进行中 ｜ ⏳ 未开始

---

## 全局设计规范（所有页面通用）
- **主题统一**：字体层级、字号、间距、圆角、阴影、色板统一由 `AppTheme`、`AppSpacing`、`AppRadius`、`AppTypography` 提供，组件通过封装（如 `PrimaryButton`、`AppCard`、`AppTextField`）复用，禁止散落样式。
- **交互与动效**：页面切换、BottomSheet、列表刷新、骨架屏、空态、错误提示在 `ThemeData` 与自定义 `PageTransitionsTheme` 中统一配置；交互反馈（点击水波纹、加载、空态插画、错误 Snackbar）遵循统一的 UX 指南。
- **设计验收**：上线前逐屏对齐 UI 稿核对字体/颜色/图标尺寸；Figma ↔ Flutter 建立 Review Checklist；关键组件补充 Golden Test 捕获样式回退。
- **无障碍与国际化**：文本遵循最小字号 14sp、元素对比度 ≥ 4.5；支持动态字体、深浅色主题与屏幕阅读器标签；文案集中于 `intl` 资源管理。

---

## 高优先级

### ✅ 1. 认证与会话（登录、注册、退出、令牌管理）
- **用户旅程**：品牌登录页 → 邮箱+密码登录 → 失败提示或进入主页；注册输入昵称/邮箱/密码/语言 → 自动登录并持久化；下次启动 Splash 静默校验令牌；个人中心可退出并清理会话。
- **UI & 交互**：登录/注册卡片、输入框显隐、错误提示、加载态符合 UI 稿；支持键盘自动焦点、自动填充、暗色模式；全局 Snackbar/M3 对话框反馈。
- **前端任务**：`AuthController` 管理访问/刷新令牌、SharedPreferences 持久化、API 客户端注入 Bearer 头、错误上报；登录/注册表单进行实时校验与禁用按钮；退出时重置所有 Feature 的 Provider 状态。
- **后端任务**：`/auth/login` 返回访问+刷新 JWT、到期时间、用户属性（语言/昵称）；`/auth/refresh` 刷新访问令牌；`/users` 注册校验邮箱唯一、密码加盐、种子默认数据；所有凭证、用户信息在 MySQL 中维护，禁止文件或内存伪造。

### ✅ 2. 主页数据闭环（Home Feed + 快捷操作 + 习惯预览）
- **用户旅程**：进入主页 → 顶部问候卡（时间、心情提示）→ 列表/卡片模式切换 → 下拉刷新 → 查看快捷操作 → 今日习惯 → 空态/错误态引导。
- **UI & 交互**：
  - Header 展示问候语、日期、推荐标签；`HomeModeToggle` 控制列表/网格模式并有动画反馈。
  - 主体支持 Loading Skeleton、空态卡片、错误重试、RefreshIndicator；FAB 快速写日记。
  - QuickAction 卡片支持动态色值、图标、本地化文本；Habit 列表展示进度、状态、提示文案。
- **数据与后端**：`/home/feed` 聚合 `/notes/feed`、`/habits/feed` 与快捷操作；快捷操作来自 MySQL 表 `quick_actions`、`quick_action_translations`（含 icon、排序、颜色、默认文案、多语言），已移除 JSON；若表为空返回空数组由前端展示空态；需要 Alembic 迁移脚本与运营维护流程。
- **前端实现**：`HomeController` 支持四种状态（initial/loading/ready/failure）与刷新；`HomeScreen` 按设计拆分模块，`NoteDetailSheet` 底部弹窗查看详情；Profile Tab 显示用户信息与退出按钮。

### ✅ 3. 笔记 CRUD（列表/详情/创建/编辑/删除）
- **用户旅程**：主页/快捷入口 → “查看全部”进入笔记列表 → 列表/卡片浏览、筛选分类/标签 → 搜索关键词 → 查看详情（底部抽屉或详情页）→ 创建/编辑笔记（标题、正文、分类、进度、标签、附件链接）→ 保存后即时刷新 → 支持删除并同步首页/列表状态。
- **UI & 交互**：
  - 新增 `NoteListScreen`：顶部搜索、分类/标签筛选、多状态（加载/空/错误/搜索结果）、下拉刷新、FAB 新建。
  - `NoteDetailScreen` 展示标签、附件、进度、时间线，支持编辑/删除；首页 `NoteDetailSheet` 也显示标签/附件并可跳转详情。
  - `NoteEditorScreen` 提供表单（标题、摘要、日期、分类、进度滑块、正文、标签 chips、附件编辑），提交态/错误提示完善。
- **数据与后端**：`notes` 体系新增 MySQL 表 `note_attachments`、`note_tags`、`note_tag_links`；`/notes` CRUD 支持附件/标签字段；`/notes/feed` & `/home/feed` 返回标签元数据；新建 `/notes/search` 提供关键词检索；所有关联操作封装在 `NoteRepository`，自动维护 `has_attachment`、标签唯一性与事务提交。前端 `RemoteNoteRepository` 统一封装调用并同步 Session。

### ✅ 4. 日记工作流（模板、撰写、详情、分享）
- **用户旅程**：主页快捷卡 → 模板横滑 → 底部撰写抽屉（天气、标签、心情、分享开关）→ 创建 → 日记列表/详情页支持编辑、删除、分享。
- **UI & 交互**：模板区横向列表、模板预览卡；撰写表单支持草稿保存、图片/语音附件、Tag Chips、Mood Picker；详情页沉浸式背景、分享弹窗、CTA 行动按钮。
- **数据与后端**：`diaries` 表扩展天气、标签（JSON/关系表）、分享标记、模板引用；模板数据（含多语言）存 MySQL（例如 `diary_templates` + `diary_template_translations`）；从 `/diaries/feed` 返回模板库；提供导出/分享接口（可返回短链或 PDF 任务）。
- ✅ **交付情况**：后端已落地模板、分享、附件等接口，Flutter 端完成创建/编辑/分享流程，日记模板与 Feed 数据均来自 MySQL。

### ✅ 5. 习惯打卡（时间线、进度、提醒）
- **用户旅程**：主页 → 今日习惯卡片 → 进入习惯页 → 查看日历时间线、进度面板、任务列表 → 勾选完成/撤销 → 新建习惯（标题、描述、提醒、周期、颜色）→ 保存刷新 → 查看历史统计。
- **UI & 交互**：横向时间线突出今日、完成数量；进度面板展示连续天数/专注时长；Habit Tile 有状态切换动画、错误提示；新增页包含表单验证、提醒时间选择、图标/颜色选择。
- **数据与后端**：`habits`、`habit_translations`、`habit_entries`（历史打卡记录）扩展提醒时间、重复规则、颜色；`/habits/feed` 返回日历统计、连续天数、概览指标；更新状态写入历史表并返回最新 Feed。
- ✅ **交付情况**：FastAPI `/habits` 系列接口已实现提醒、历史统计与 Feed 聚合，Flutter 习惯模块支持打卡、统计面板与提醒设置。

---

## 中优先级

### ✅ 6. 任务/清单模块（待办 + 提醒）
- **用户旅程**：主页快捷卡 → 待办页面 → 查看今日/本周任务 → 添加提醒/优先级/标签 → 勾选完成/拖动排序 → 与日记/笔记关联。
- **UI & 交互**：任务列表分组、滑动操作、批量完成、提醒时间选择器、空态引导；主页显示任务统计卡。
- **数据与后端**：新建 `tasks`、`task_tags`、`task_reminders` 表；支持标签、优先级、关联实体 ID；REST 接口含 CRUD、批量完成、筛选、分页。
- ✅ **后端完成**：FastAPI 已实现 `/api/tasks` CRUD、过滤、批量完成与 `/api/tasks/stats` 统计，`/api/home/feed` 返回任务概览数据。

### ✅ 7. 语音笔记（录音、转写、播放）
- **用户旅程**：主页语音卡 → 弹出录音面板 → 实时波形/计时 → 结束上传 → 看到转写文本 → 存入笔记列表可回放/文字编辑。
- **UI & 交互**：录音按钮、波形动画、暂停/恢复、上传进度、失败重试、后台上传通知；详情页内嵌播放器与文本同步。
- **数据与后端**：音频文件存储（对象存储地址）、数据库记录元数据/时长/转写状态；使用任务队列异步转写更新内容；`/audio-notes` 提供 CRUD、下载、转写状态查询。
- ✅ **交付情况**：新增 `audio_notes` 表及 FastAPI `/api/audio-notes` 全量接口，支持录音元数据持久化、状态过滤、转写结果更新与外部下载地址。

### ✅ 8. 个人中心（资料、语言、主题、安全）
- **用户旅程**：底部“我的” → 查看头像/昵称/邮箱/统计 → 修改头像/昵称/语言/主题 → 账号安全（修改密码、双重验证入口）→ 退出登录。
- **UI & 交互**：信息卡片、设置列表、上传头像裁剪、语言/主题即时生效；安全区使用 Step-by-step 提示。
- **数据与后端**：`/users/me` 返回统计（笔记数、连续打卡、最近活跃）、语言、主题、头像 URL；`/users/{id}` PATCH 更新资料并写数据库；上传头像需存储对象地址与缩略图。
- ✅ **交付情况**：用户模型扩展头像、主题、最近活跃字段，`/api/users/me` 返回笔记/日记/习惯统计与打卡连胜，登录与刷新令牌时更新 `last_active_at`。

### ✅ 9. 搜索与过滤（全局检索）
- **用户旅程**：主页搜索框 → 输入关键字 → 实时返回候选（笔记/日记/任务/习惯）→ 筛选标签/日期/类型 → 跳转详情。
- **UI & 交互**：搜索框支持历史记录、清空、骨架结果；结果列表分组显示类型，支持分页加载与空态提示。
- **数据与后端**：统一 `/search` API，支持多模块联合检索、分页、排序；可结合数据库全文索引或 Elastic；记录搜索日志以优化推荐。
- ✅ **交付情况**：新增 `/api/search` 全局检索接口聚合笔记/日记/任务/习惯/语音笔记，可按类型与日期过滤并返回分组结果。

---

## 低优先级

### ⏳ 10. 多语言与本地化
- 扩充 `intl` 资源、支持繁体/英文；日期、货币、度量单位本地化；后端根据 `Accept-Language` 返回多语言模板/快捷操作/错误信息。

### ⏳ 11. 离线与缓存
- 前端增加持久缓存（Hive/SQLite）、乐观更新、失败回滚；离线时显示提示与重试队列；后端提供 `updated_at`/`etag`/增量同步接口。

### ⏳ 12. 推送提醒
- 前端整合本地通知 + FCM，处理权限请求、点击跳转、静默更新；后端使用调度器（Celery/APScheduler）生成提醒任务，支持多时区、重复周期、通知渠道。

### ⏳ 13. 质量与运维提升
- 前端：单元/集成测试、Golden 与性能指标、Crashlytics；后端：数据库迁移、种子数据、契约测试、APM/日志/告警；建立 CI/CD、代码扫描、数据库备份策略。

---

## 执行顺序建议
1. **认证与会话** ✅（已交付：JWT 会话、自动登录、退出清理）。
2. **主页闭环** ✅（已交付：MySQL 快捷操作、Loading/Empty/错误态、刷新逻辑）。
3. **核心 CRUD（笔记/日记/习惯）**：按价值优先推进，先保证 MySQL 模型完整、接口可用，再打磨体验。
4. **增强模块（任务、语音、个人中心、搜索）**：核心闭环后并行展开，注意跨模块依赖。
5. **质量/多语言/离线/推送**：纳入专门冲刺，保证国际化与稳定性。

> **数据库提醒**：在交付新模块前务必准备 Alembic 迁移、初始化脚本与示例数据，确保环境启动即有完整体验。
